---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Analytics from '../components/Analytics.astro';
import { BRAND_ASSETS } from '../data/brand-assets.generated';
import '../styles/global.css';

export interface Props {
  title: string;
  description: string;
  ogImage?: string;
  canonical?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  section?: string;
  tags?: string[];
}

const {
  title,
  description,
  ogImage,
  canonical,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  section,
  tags = []
} = Astro.props;

// Get the OG image asset
const ogAsset = BRAND_ASSETS['modern_ledger_1200x630.png'];
const defaultOgImage = ogAsset ? ogAsset.path : '/og-default.jpg';
const finalOgImage = ogImage || defaultOgImage;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Tag Manager -->
  <script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5PH8SRL5');</script>
  <!-- End Google Tag Manager -->

  <title>{title}</title>
  <meta name="description" content={description}>
  <link rel="canonical" href={canonical || Astro.url.href}>

  <!-- Open Graph -->
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:image" content={new URL(finalOgImage, Astro.site).href}>
  <meta property="og:image:width" content={ogAsset?.width.toString() || "1200"}>
  <meta property="og:image:height" content={ogAsset?.height.toString() || "630"}>
  <meta property="og:url" content={Astro.url.href}>
  <meta property="og:type" content={type}>
  <meta property="og:site_name" content="Modern Ledger">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={title}>
  <meta name="twitter:description" content={description}>
  <meta name="twitter:image" content={new URL(finalOgImage, Astro.site).href}>

  <!-- Article specific -->
  {type === 'article' && publishedTime && (
    <meta property="article:published_time" content={publishedTime}>
  )}
  {type === 'article' && modifiedTime && (
    <meta property="article:modified_time" content={modifiedTime}>
  )}
  {type === 'article' && author && (
    <meta property="article:author" content={author}>
  )}
  {type === 'article' && section && (
    <meta property="article:section" content={section}>
  )}
  {type === 'article' && tags.length > 0 && tags.map(tag => (
    <meta property="article:tag" content={tag}>
  ))}

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/modern_ledger_32x32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="/modern_ledger_64x64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="/modern_ledger_128x128.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/modern_ledger_256x256.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/modern_ledger_512x512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/modern_ledger_256x256.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="//www.google-analytics.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">

  <!-- Umami Analytics -->
  <script is:inline defer src="https://cloud.umami.is/script.js" data-website-id="b31033f3-f5e0-4534-83ea-1679fc594432"></script>

  <!-- GA4 Analytics Component -->
  <Analytics />

  <!-- JSON-LD Schema -->
  <script is:inline type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "@id": "https://modernledger.co/#localbusiness",
    "name": "Modern Ledger",
    "url": "https://modernledger.co/",
    "telephone": "+1-469-534-3392",
    "email": "sales@thekpsgroup.com",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Royse City",
      "addressRegion": "TX",
      "addressCountry": "US"
    },
    "areaServed": ["Royse City TX","Rockwall TX","Fate TX","Caddo Mills TX","Greenville TX","Quinlan TX","Rowlett TX","Wylie TX","Heath TX"],
    "priceRange": "$$",
    "aggregateRating": { "@type": "AggregateRating", "ratingValue": "5.0", "reviewCount": "5" },
    "review": [
      { "@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Bailey Motes"},"reviewBody":"Absolutely love this company! Karson has been the biggest help getting me on track for a great future in business. Flexible hours and cost to accommodate all business types and sizes! So very thankful for them." },
      { "@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Amy Nguyen"},"itemReviewed":{"@type":"Organization","name":"Modern Ledger"},"reviewBody":"The KPS Group was incredibly helpful! Karson took the time to understand our needs and helped modernize our tools, marketing, and accounting systems. Super knowledgeable, easy to work with, and genuinely cares about helping businesses grow. Highly recommend!" },
      { "@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Amber Smith"},"reviewBody":"Karson is professional and committed to his business!" },
      { "@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Adam Farmer"},"reviewBody":"Top notch consulting and bookkeeping services. Penny Joy Consulting was a game changer for my small business. Highly recommend." },
      { "@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Brandon & Holly Gibson"},"reviewBody":"An amazing consultant for our growing business!" }
    ]
  }
  </script>
</head>
<body class="font-sans">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5PH8SRL5"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Skip to main content -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 rounded-md bg-brand-navy px-4 py-2 text-white shadow-card transition-transform focus:-translate-y-1">
    Skip to main content
  </a>

  <div class="min-h-screen flex flex-col">
    <Header />
    <main id="main-content" class="flex-1 w-full">
      <slot />
    </main>
    <Footer />
  </div>

  <!-- Cookie Consent -->
  <div id="cookie-consent" class="fixed bottom-4 left-1/2 z-40 hidden w-[calc(100%-2rem)] -translate-x-1/2 rounded-2xl bg-brand-navy px-6 py-5 text-white shadow-elevation md:max-w-4xl">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div class="flex-1">
        <h3 class="text-lg font-semibold mb-2">We Value Your Privacy</h3>
        <p class="text-sm text-white/80 mb-3">
          We use cookies and similar technologies to enhance your experience, analyze site usage, and provide personalized content. By continuing to use our site, you consent to our use of cookies in accordance with our <a href="/privacy" class="underline hover:text-brand-gold transition-colors">Privacy Policy</a>.
        </p>
        <div class="text-xs text-white/60">
          <p class="mb-1"><strong>Essential Cookies:</strong> Required for site functionality and security</p>
          <p class="mb-1"><strong>Analytics Cookies:</strong> Help us understand how visitors use our site</p>
          <p><strong>Marketing Cookies:</strong> Used to deliver relevant advertisements</p>
        </div>
      </div>
      <div class="flex w-full flex-col gap-2 md:w-auto md:min-w-[200px]">
        <button id="accept-all-cookies" class="btn btn-secondary w-full justify-center md:w-auto">Accept All Cookies</button>
        <button id="accept-essential-cookies" class="btn btn-inverse w-full justify-center md:w-auto">Essential Only</button>
        <button id="customize-cookies" class="btn btn-outline w-full justify-center md:w-auto text-sm">Customize</button>
      </div>
    </div>

    <!-- Cookie Customization Panel (Hidden by default) -->
    <div id="cookie-customization" class="hidden mt-4 pt-4 border-t border-white/10">
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium">Essential Cookies</h4>
            <p class="text-xs text-white/60">Required for website functionality</p>
          </div>
          <input type="checkbox" checked disabled class="rounded border-white/20 bg-white/10" />
        </div>
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium">Analytics Cookies</h4>
            <p class="text-xs text-white/60">Help us improve our website</p>
          </div>
          <input type="checkbox" id="analytics-cookies" class="rounded border-white/20 bg-white/10" />
        </div>
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-medium">Marketing Cookies</h4>
            <p class="text-xs text-white/60">Personalized ads and content</p>
          </div>
          <input type="checkbox" id="marketing-cookies" class="rounded border-white/20 bg-white/10" />
        </div>
        <div class="flex justify-end gap-2 mt-3">
          <button id="save-preferences" class="btn btn-primary text-sm">Save Preferences</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .sr-only.focus:not-sr-only {
      position: static;
      width: auto;
      height: auto;
      padding: initial;
      margin: initial;
      overflow: visible;
      clip: auto;
      white-space: normal;
    }
  </style>

  <script>
    // Global type declarations
    declare global {
      interface Window {
        analytics?: {
          setConsent: (consent: 'granted' | 'denied') => void;
          trackLeadSubmit: (formId: string, page: string) => void;
          trackCallClick: (phoneNumber: string, page: string) => void;
          trackEmailClick: (email: string, page: string) => void;
          trackCTAClick: (ctaText: string, page: string) => void;
          trackCalculatorUsed: (inputsHash: string, page: string) => void;
          hasConsent: () => boolean;
        };
      }
    }
    // Enhanced Cookie Consent Management
    document.addEventListener('DOMContentLoaded', () => {
      const consent = localStorage.getItem('cookie-consent');
      const consentVersion = localStorage.getItem('cookie-consent-version');
      const currentVersion = '1.0'; // Increment when privacy policy changes

      // Show banner if no consent or outdated version
      if (!consent || consentVersion !== currentVersion) {
        document.getElementById('cookie-consent')?.classList.remove('hidden');
      }

      // Accept All Cookies
      document.getElementById('accept-all-cookies')?.addEventListener('click', () => {
        localStorage.setItem('cookie-consent', 'accepted');
        localStorage.setItem('cookie-consent-version', currentVersion);
        localStorage.setItem('analytics-cookies', 'true');
        localStorage.setItem('marketing-cookies', 'true');
        document.getElementById('cookie-consent')?.classList.add('hidden');
        initializeAnalytics();
        // Set GA4 consent
        if (window.analytics) {
          window.analytics.setConsent('granted');
        }
      });

      // Accept Essential Only
      document.getElementById('accept-essential-cookies')?.addEventListener('click', () => {
        localStorage.setItem('cookie-consent', 'essential-only');
        localStorage.setItem('cookie-consent-version', currentVersion);
        localStorage.setItem('analytics-cookies', 'false');
        localStorage.setItem('marketing-cookies', 'false');
        document.getElementById('cookie-consent')?.classList.add('hidden');
        // Essential cookies only - no analytics initialization
      });

      // Customize Cookies
      document.getElementById('customize-cookies')?.addEventListener('click', () => {
        const customization = document.getElementById('cookie-customization');
        customization?.classList.toggle('hidden');

        // Load saved preferences
        const analyticsEnabled = localStorage.getItem('analytics-cookies') === 'true';
        const marketingEnabled = localStorage.getItem('marketing-cookies') === 'true';
        (document.getElementById('analytics-cookies') as HTMLInputElement).checked = analyticsEnabled;
        (document.getElementById('marketing-cookies') as HTMLInputElement).checked = marketingEnabled;
      });

      // Save Custom Preferences
      document.getElementById('save-preferences')?.addEventListener('click', () => {
        const analyticsEnabled = (document.getElementById('analytics-cookies') as HTMLInputElement).checked;
        const marketingEnabled = (document.getElementById('marketing-cookies') as HTMLInputElement).checked;

        localStorage.setItem('cookie-consent', 'custom');
        localStorage.setItem('cookie-consent-version', currentVersion);
        localStorage.setItem('analytics-cookies', analyticsEnabled.toString());
        localStorage.setItem('marketing-cookies', marketingEnabled.toString());

        document.getElementById('cookie-consent')?.classList.add('hidden');

        if (analyticsEnabled) {
          initializeAnalytics();
          // Set GA4 consent
          if (window.analytics) {
            window.analytics.setConsent('granted');
          }
        } else {
          // Deny GA4 consent
          if (window.analytics) {
            window.analytics.setConsent('denied');
          }
        }
      });
    });

    // Initialize Analytics (Google Tag Manager & Umami)
    function initializeAnalytics() {
      // Google Tag Manager is already loaded in the head
      // Umami is already loaded in the head
      console.log('Analytics initialized');
    }
  </script>
</body>
</html>